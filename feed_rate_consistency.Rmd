---
title: "Feeding rate consistency"
author: "Nima Moghaddas"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=F, warning=F}
library(malariasimulation)
library(lme4)
library(dplyr)
```

We are interested to know whether feeding rates change over time which would provide reason for including a time varying feeding rate in the final simulations. One way to do this is to fit a generalised linear mixed effects models with a random effect on cluster/village and a random effect on date.If the random effect for date is greater than cluster, this provides evidence that there is variation in feeding rates over time over and above the variation between clusters. Here is the cluster level feeding rate data for Zambia and Mali.

```{r, include=FALSE}
library(lubridate)
mali <- read.csv("~/GitHub/atsb_working_code/DB monthly natural sugar and ASB feeding/day 2-Table 1.csv")[-(64:65),]
mali$dyed_fraction <- mali$females.ASB.positive/mali$TOTAL.Sample.females.Day.2
mali$total_asb_positive <- mali$females.ASB.positive 
mali$total_sampled <- mali$TOTAL.Sample.females.Day.2 
mali$days <- (mali$month-1)*30+mali$Day
zambia <- read.csv("~/GitHub/zambia_feeding_data")
zambia$days <- (month(zambia$collection_date)-1)*30 + day(zambia$collection_date)
```
```{r, fig.width = 10, fig.height = 4, message=F}
par(las=1, mfrow=c(1,2))
# The Zambia trial has data for every mosquito caught so first we need to summarise across cluster and date
zambia |> 
  group_by(collection_date, cluster) |>
  summarise(dyed_fraction = sum(positive)/n()) -> zambia_grouped
zambia_grouped$days <- (month(zambia_grouped$collection_date)-1)*30 + day(zambia_grouped$collection_date)
plot(zambia_grouped$days,
     zambia_grouped$dyed_fraction,
     cex=1.1, pch=20, frame.plot = F, xlab = "Day", ylab = "% bait fed",
     ylim = c(0,1), cex.axis=1.2, xlim = c(1,365))
grid()
title("Zambia 2021")
# The Mali trial only has data for total stained and unstained mosquitoes by village and date
plot(mali$days, 
     mali$dyed_fraction,
     cex=1.1, pch=20, frame.plot = F, xlab = "Day", ylab = "% bait fed",
     ylim = c(0,1), cex.axis=1.2, xlim = c(1,365))
grid()
title("Mali 2017")

```

We can fit a GLMM with random effects on cluster and day.

```{r}
fit <- glmer(
  positive ~ (1|cluster) + (1|days),
  data = zambia, family = "binomial", control = glmerControl(optimizer = "bobyqa")
)
summary(fit)
```
```{r}
# mali$Village <- factor(mali$Village)
# form <- "dyed_fraction ~ (1|Village) + (1|days)"
# fit <-
#   glmer(
#     cbind(total_sampled, 1 - total_asb_positive) ~ 
#       (1|Village) + (1|days),
#     family = "binomial", data = mali,
#     control = glmerControl(optimizer = "bobyqa"))
# fit <-
#   glmer(
#   cbind(tot_dead, total - tot_dead) ~
#     treatment + (1 | hut) + (1 | sleeper) + (1 | observation),
#     family = binomial, data = df)
```


